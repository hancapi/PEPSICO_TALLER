{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ingreso de Veh√≠culos - Taller PepsiCo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="{% static 'css/style.css' %}"/>
</head>
<body>
  {% include "partials/sidebar.html" with menu_active="ingreso" %}

  <div class="main-content p-3">
    <div class="row mb-4">
      <div class="col-12 d-flex justify-content-end align-items-center gap-3">
        <div class="small text-muted">
          Crear√°s como: <strong id="whoamiRut">‚Äî</strong>
          <span class="text-muted">(<span id="whoamiUser">‚Äî</span>)</span>
        </div>
        <a href="/inicio-sesion/" class="btn btn-outline-danger" id="logoutButton">üîí Cerrar Sesi√≥n</a>
      </div>
    </div>

    <div class="page-header welcome-card mb-4">
      <h1 class="mb-1">üöó Ingreso de Veh√≠culos</h1>
      <p class="mb-0">Agenda anti-solapamientos (slots de 30 minutos). El responsable se infiere desde tu sesi√≥n.</p>
    </div>

    <div class="row g-3">
      <!-- Panel de Agenda -->
      <div class="col-lg-7">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title mb-3">Agenda</h5>

            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label" for="fecha">Fecha</label>
                <input type="date" id="fecha" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label" for="tallerId">Taller</label>
                <select id="tallerId" class="form-select">
                  <option value="1">Taller 1</option>
                </select>
              </div>
              <div class="col-md-4">
                <button class="btn btn-outline-primary w-100" id="btnCargarAgenda">üîÑ Cargar Agenda</button>
              </div>
            </div>

            <div class="calendar-container mt-3">
              <div class="d-flex justify-content-between align-items-center">
                <strong>Disponibilidad</strong>
                <span class="small text-muted">Jornada: 08:00‚Äì18:00 / 30 min</span>
              </div>

              <div id="slotsGrid" class="time-slots mt-2"></div>

              <div class="schedule-summary alert alert-info py-2 px-3 mt-3 d-none" id="slotResumen" role="alert">
                Seleccionado: <strong id="slotSel"></strong>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario de Ingreso -->
      <div class="col-lg-5">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title mb-3">Crear Ingreso</h5>

            <form id="formIngreso" autocomplete="off" novalidate>
              <div class="mb-2">
                <label class="form-label" for="patente">Patente</label>
                <input
                  type="text"
                  id="patente"
                  class="form-control"
                  placeholder="ABCZ12"
                  pattern="[A-Z0-9\-]{4,10}"
                  title="Usa 4 a 10 caracteres en MAY√öSCULAS, n√∫meros y guion (-)"
                  maxlength="10"
                  oninput="this.value=this.value.toUpperCase()"
                  required
                />
                <div class="form-text">Usa letras y n√∫meros (ej: ABCZ12). Se convertir√° a may√∫sculas autom√°ticamente.</div>
              </div>

              <div class="mb-2">
                <label class="form-label" for="descripcion">Descripci√≥n (opcional)</label>
                <textarea id="descripcion" class="form-control" rows="3" placeholder="Motivo del ingreso..."></textarea>
              </div>

              <div class="d-grid">
                <button type="submit" id="btnCrear" class="btn btn-primary" disabled>üíæ Crear OT</button>
              </div>

              <!-- Alertas de resultado -->
              <div id="okIngreso"  class="alert alert-success mt-3 d-none" role="alert">‚úÖ OT creada correctamente</div>
              <div id="errIngreso" class="alert alert-danger  mt-3 d-none" role="alert">‚ùå Error al crear OT</div>
            </form>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h6 class="card-title mb-2">Tips</h6>
            <ul class="small text-muted mb-0">
              <li>Un veh√≠culo no puede tener dos ingresos en curso el mismo d√≠a.</li>
              <li>No se puede crear ingreso si el slot ya est√° ocupado en el taller.</li>
              <li>Estados que bloquean: <strong>Pendiente</strong> y <strong>En Proceso</strong>.</li>
              <li>El campo <code>rut_creador</code> se guarda autom√°ticamente desde tu sesi√≥n.</li>
            </ul>
          </div>
        </div>
      </div>
    </div> <!-- row -->
  </div> <!-- main-content -->

  <script src="{% static 'js/auth.js' %}"></script>

  <!-- whoami (silencioso si el endpoint no existe) -->
  <script>
    (async function fetchWhoAmI() {
      try {
        const res = await fetch('/api/ordenestrabajo/api/whoami/', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById('whoamiRut').textContent  = data.rut || '‚Äî';
        document.getElementById('whoamiUser').textContent = data.usuario || '‚Äî';
      } catch(_) {}
    })();

    // Fecha por defecto = hoy
    (function setDefaultDate() {
      const f = document.getElementById('fecha');
      if (f && !f.value) {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        f.value = `${yyyy}-${mm}-${dd}`;
      }
    })();
  </script>

  <script src="{% static 'js/ingreso_vehiculos.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
