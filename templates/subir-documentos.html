{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Subir Documentos - Taller PepsiCo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- CSS central -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="p-3 text-center border-bottom">
      <h5>Taller PepsiCo Chile</h5>
    </div>
    <nav class="nav flex-column">
      <a class="nav-link" href="/inicio/">üè† Inicio</a>
      <a class="nav-link" href="/ingreso-vehiculos/">üöó Ingreso Veh√≠culos</a>
      <a class="nav-link active" href="/subir-documentos/">üìé Documentos</a>
      <a class="nav-link" href="/reportes/">üìä Reportes</a>
    </nav>
  </div>

  <!-- CONTENIDO -->
  <div class="main-content p-3">
    <div class="row mb-4">
      <div class="col-12 text-end">
        <a href="/inicio-sesion/" class="btn btn-outline-danger" id="logoutButton">üîí Cerrar Sesi√≥n</a>
      </div>
    </div>

    <div class="page-header welcome-card">
      <h1 class="mb-0">üìé Subir Documentos</h1>
      <p class="mb-0">Sistema de gesti√≥n documental del taller</p>
    </div>

    <div class="row">
      <!-- Formulario -->
      <div class="col-md-6">
        <div class="card upload-card">
          <div class="card-body">
            <h5 class="card-title mb-3">Adjuntar archivo</h5>

            <div class="file-upload-area" id="uploadArea">
              <div class="file-icon">üìÅ</div>
              <h6>Seleccionar documento</h6>
              <p class="text-muted mb-3">Arrastra y suelta o haz clic para seleccionar</p>
              <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                üìÇ Explorar Archivos
              </button>
              <input type="file" id="fileInput" style="display:none" />
              <div class="form-text mt-2">
                Formatos permitidos: <strong>PDF, JPG, PNG</strong> ‚Äî Tama√±o m√°x: <strong>15MB</strong>
              </div>
            </div>

            <div class="file-list" id="fileList"></div>

            <form id="documentForm" class="mt-4">
              <div class="mb-3">
                <label class="form-label">T√≠tulo <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="titulo" placeholder="Ej: Foto del da√±o" required />
              </div>

              <div class="mb-3">
                <label class="form-label">Tipo</label>
                <select id="tipo" class="form-select">
                  <option value="FOTO">FOTO</option>
                  <option value="INFORME">INFORME</option>
                  <option value="OTRO" selected>OTRO</option>
                </select>
              </div>

              <div class="row g-2">
                <div class="col-sm-6">
                  <label class="form-label">OT ID (opcional)</label>
                  <input type="number" class="form-control" id="otId" placeholder="123" />
                </div>
                <div class="col-sm-6">
                  <label class="form-label">Patente (opcional)</label>
                  <input type="text" class="form-control" id="patente" placeholder="ABCZ12" />
                </div>
              </div>

              <div class="d-grid mt-3">
                <button type="submit" class="btn btn-primary btn-lg" id="saveButton" disabled>
                  üíæ Subir Documento
                </button>
              </div>

              <div class="small text-muted mt-2">
                Debes indicar <strong>OT ID</strong> o <strong>Patente</strong>.
              </div>

              <div class="alert alert-success mt-3 d-none" id="okAlert">‚úÖ Documento subido</div>
              <div class="alert alert-danger mt-3 d-none" id="errAlert">‚ùå Error al subir</div>
            </form>
          </div>
        </div>
      </div>

      <!-- Vista previa -->
      <div class="col-md-6">
        <div class="card upload-card">
          <div class="card-body">
            <h5 class="card-title mb-3">Vista previa</h5>

            <div class="preview-container">
              <div id="emptyPreview">
                <div class="file-icon text-muted">üëÅÔ∏è</div>
                <p class="text-muted">Selecciona un archivo para ver la vista previa</p>
              </div>

              <img id="imagePreview" class="file-preview" alt="Vista previa" style="display:none" />
              <iframe id="pdfPreview" class="file-preview" style="display:none;width:100%;height:300px;"></iframe>
              <div id="otherPreview" class="file-preview" style="display:none;padding:2rem;text-align:center;">
                <div class="file-icon">üìÑ</div>
                <h6 id="otherFileName">Archivo</h6>
                <p class="text-muted" id="otherFileInfo">Informaci√≥n del archivo</p>
              </div>

              <div id="fileInfo" class="mt-3" style="display:none;">
                <hr />
                <h6>Informaci√≥n del archivo:</h6>
                <div class="row small text-muted">
                  <div class="col-6"><strong>Nombre:</strong><br /><span id="infoFileName">-</span></div>
                  <div class="col-6"><strong>Tama√±o:</strong><br /><span id="infoSize">-</span></div>
                  <div class="col-6 mt-2"><strong>Tipo:</strong><br /><span id="infoType">-</span></div>
                  <div class="col-6 mt-2"><strong>Destino:</strong><br /><span id="infoDestino">OT o Patente</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- LISTADO DE DOCUMENTOS -->
        <div class="card upload-card mt-4">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="card-title mb-0">Documentos cargados</h5>
              <div class="d-flex gap-2">
                <input type="number" class="form-control form-control-sm" id="listOtId" placeholder="OT ID" style="width:120px;" />
                <input type="text" class="form-control form-control-sm" id="listPatente" placeholder="Patente" style="width:120px;" />
                <button class="btn btn-sm btn-outline-primary" id="btnListarDocs">üîÑ Listar</button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle" id="tablaDocs">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>T√≠tulo</th>
                    <th>Tipo</th>
                    <th>OT</th>
                    <th>Patente</th>
                    <th>Archivo</th>
                    <th>Fecha</th>
                  </tr>
                </thead>
                <tbody><!-- din√°mico --></tbody>
              </table>
            </div>
            <div id="docsEmpty" class="text-muted small">No hay documentos para los filtros ingresados.</div>
          </div>
        </div>
      </div>
    </div> <!-- row -->
  </div> <!-- main-content -->

  <!-- ===== JS (orden correcto) ===== -->
  <!-- 1) Protecci√≥n y sesi√≥n -->
  <script src="{% static 'js/auth.js' %}"></script>
  <!-- 2) Helper de documentos (exponen window.documentosUpload / documentosList) -->
  <script src="{% static 'js/documentos.js' %}"></script>
  <!-- 3) Script de p√°gina que usa los helpers -->
  <script>
    // Estado
    let selectedFile = null;

    // Tipos permitidos (deben coincidir con backend)
    const allowedMime = new Set(['application/pdf', 'image/jpeg', 'image/png']);
    const maxSize = 15 * 1024 * 1024; // 15MB

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      initUploadArea();
      document.getElementById('fileInput').addEventListener('change', (e) => handleFileSelect(e.target.files));
      document.getElementById('documentForm').addEventListener('submit', onSubmit);

      // si viene patente/ot desde la URL
      const qs = new URLSearchParams(location.search);
      const p = qs.get('patente'); if (p) document.getElementById('patente').value = p;
      const otQ = qs.get('ot_id'); const patQ = qs.get('patente');
      if (otQ) document.getElementById('listOtId').value = otQ;
      if (patQ) document.getElementById('listPatente').value = patQ;
      if (otQ || patQ) listarDocumentos();

      // eventos del listado
      document.getElementById('btnListarDocs').addEventListener('click', listarDocumentos);
      document.getElementById('otId').addEventListener('input', () => { updateDestinoInfo(); toggleSave(); });
      document.getElementById('patente').addEventListener('input', () => { updateDestinoInfo(); toggleSave(); });
      document.getElementById('titulo').addEventListener('input', toggleSave);
    });

    function initUploadArea() {
      const area = document.getElementById('uploadArea');
      area.addEventListener('dragover', (e) => { e.preventDefault(); area.classList.add('dragover'); });
      area.addEventListener('dragleave', () => area.classList.remove('dragover'));
      area.addEventListener('drop', (e) => {
        e.preventDefault();
        area.classList.remove('dragover');
        handleFileSelect(e.dataTransfer.files);
      });
      area.addEventListener('click', () => document.getElementById('fileInput').click());
    }

    function handleFileSelect(files) {
      if (!files || !files.length) return;
      const f = files[0];

      if (!allowedMime.has(f.type)) { alert('Tipo no permitido. Usa PDF, JPG o PNG.'); return; }
      if (f.size > maxSize)       { alert('Archivo supera 15MB.'); return; }

      selectedFile = f;
      renderFile(f);
      toggleSave();
    }

    function renderFile(f) {
      // limpiar previas
      document.getElementById('emptyPreview').style.display = 'none';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('pdfPreview').style.display = 'none';
      document.getElementById('otherPreview').style.display = 'none';
      document.getElementById('fileInfo').style.display = 'block';
      document.getElementById('okAlert').classList.add('d-none');
      document.getElementById('errAlert').classList.add('d-none');

      // info
      document.getElementById('infoFileName').textContent = f.name;
      document.getElementById('infoSize').textContent = formatSize(f.size);
      document.getElementById('infoType').textContent = f.type;
      updateDestinoInfo();

      // preview
      if (f.type.startsWith('image/')) {
        const r = new FileReader();
        r.onload = (e) => { const img = document.getElementById('imagePreview'); img.src = e.target.result; img.style.display = 'block'; };
        r.readAsDataURL(f);
      } else if (f.type === 'application/pdf') {
        const r = new FileReader();
        r.onload = (e) => { const pdf = document.getElementById('pdfPreview'); pdf.src = e.target.result; pdf.style.display = 'block'; };
        r.readAsDataURL(f);
      } else {
        document.getElementById('otherFileName').textContent = f.name;
        document.getElementById('otherFileInfo').textContent = `Tipo: ${f.type} | Tama√±o: ${formatSize(f.size)}`;
        document.getElementById('otherPreview').style.display = 'block';
      }

      // lista visual arriba
      const list = document.getElementById('fileList');
      list.innerHTML = `
        <div class="file-item">
          <div class="file-info">
            <span class="file-icon">üìÑ</span>
            <div style="flex:1;">
              <div class="file-name">${f.name}</div>
              <small class="text-muted">${formatSize(f.size)}</small>
            </div>
          </div>
          <div>
            <span class="file-type-badge">${f.name.split('.').pop().toUpperCase()}</span>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeFile()">üóëÔ∏è</button>
          </div>
        </div>`;
    }

    function updateDestinoInfo() {
      const ot = document.getElementById('otId').value.trim();
      const pat = document.getElementById('patente').value.trim();
      document.getElementById('infoDestino').textContent = ot ? `OT ${ot}` : (pat ? `Patente ${pat}` : '‚Äî');
    }

    function toggleSave() {
      const can = !!selectedFile &&
                  !!document.getElementById('titulo').value.trim() &&
                  (document.getElementById('otId').value.trim() || document.getElementById('patente').value.trim());
      document.getElementById('saveButton').disabled = !can;
    }

    function removeFile() {
      selectedFile = null;
      document.getElementById('fileList').innerHTML = '';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('pdfPreview').style.display = 'none';
      document.getElementById('otherPreview').style.display = 'none';
      document.getElementById('emptyPreview').style.display = 'block';
      toggleSave();
    }

    function formatSize(bytes) {
      if (!bytes) return '0 B';
      const u = ['B','KB','MB','GB']; let i = 0; let n = bytes;
      while (n >= 1024 && i < u.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(2)} ${u[i]}`;
    }

    async function onSubmit(e) {
      e.preventDefault();
      if (!selectedFile) return;

      const titulo  = document.getElementById('titulo').value.trim();
      const tipo    = document.getElementById('tipo').value;
      const otId    = document.getElementById('otId').value.trim();
      const patente = document.getElementById('patente').value.trim();

      const btn = document.getElementById('saveButton');
      btn.disabled = true; btn.innerText = '‚è≥ Subiendo...';

      try {
        const payload = { file: selectedFile, titulo, tipo, otId: otId || null, patente: patente || null };
        await documentosUpload(payload); // helper de static/js/documentos.js
        document.getElementById('okAlert').classList.remove('d-none');
        document.getElementById('errAlert').classList.add('d-none');

        // reset
        removeFile();
        document.getElementById('documentForm').reset();

        // refrescar listado si hay filtro activo
        const hasFilter = document.getElementById('listOtId').value || document.getElementById('listPatente').value;
        if (hasFilter) listarDocumentos();
      } catch (err) {
        console.error(err);
        document.getElementById('okAlert').classList.add('d-none');
        document.getElementById('errAlert').classList.remove('d-none');
        document.getElementById('errAlert').textContent = '‚ùå ' + (err.message || 'Error al subir');
      } finally {
        btn.disabled = false; btn.innerText = 'üíæ Subir Documento';
      }
    }

    async function listarDocumentos() {
      const otId = document.getElementById('listOtId').value.trim();
      const patente = document.getElementById('listPatente').value.trim();

      try {
        const items = await documentosList({ otId: otId || null, patente: patente || null });
        renderTablaDocs(items);
      } catch (e) {
        console.error(e);
        renderTablaDocs([]);
        alert(e.message || 'Error al listar documentos');
      }
    }

    function renderTablaDocs(items) {
      const tbody = document.querySelector('#tablaDocs tbody');
      const empty = document.getElementById('docsEmpty');
      tbody.innerHTML = '';

      if (!items || !items.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      for (const d of items) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.id}</td>
          <td>${escapeHtml(d.titulo)}</td>
          <td>${d.tipo}</td>
          <td>${d.ot_id ?? '-'}</td>
          <td>${d.patente ?? '-'}</td>
          <td>${d.archivo ? `<a href="${d.archivo}" target="_blank" rel="noopener">Ver</a>` : '-'}</td>
          <td><small>${new Date(d.creado_en).toLocaleString()}</small></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, s => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[s]));
    }
  </script>
  <!-- 4) Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
